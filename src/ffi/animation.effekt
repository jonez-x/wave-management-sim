module src/ffi/animation

extern js """
  let $running = false;
  let $lastTime = 0;
  let $frameId = null;
  let $deltaTime = 0;
  let $frameReady = false;

  function $startGameLoop() {
    if ($running) return;
    $running = true;
    $lastTime = performance.now();
    $frameReady = false;
    scheduleNextFrame();
  }
  
  function scheduleNextFrame() {
    $frameId = requestAnimationFrame(function(now) {
      if (!$running) return;
      
      $deltaTime = Math.min((now - $lastTime) / 1000.0, 0.1);
      $lastTime = now;
      $frameReady = true;
    });
  }
  
  function $stopGameLoop() {
    $running = false;
    if ($frameId) cancelAnimationFrame($frameId);
  }
  
  function $isGameLoopRunning() { 
    return $running; 
  }
  
  function $isFrameReady() {
    return $frameReady;
  }
  
  function $consumeFrame() {
    var dt = $deltaTime;
    $frameReady = false;
    if ($running) scheduleNextFrame();
    return dt;
  }
  
  function $getTimeNow() {
    return performance.now() / 1000.0;
  }
"""

extern def startGameLoop(): Unit =
  js "$startGameLoop()"

extern def stopGameLoop(): Unit =
  js "$stopGameLoop()"

extern def isGameLoopRunning(): Bool =
  js "$isGameLoopRunning()"

extern def isFrameReady(): Bool =
  js "$isFrameReady()"

extern def consumeFrame(): Double =
  js "$consumeFrame()"

extern def getTimeNow(): Double =
  js "$getTimeNow()"
